{% extends "tool_base.html" %}
{% load static %}

{% block head %}

<head>
	<link rel="stylesheet" href="{% static " usc_style.css" %}" />
	<title>Isoforms Plot Generator</title>
	<style>
		.tool-container {
			max-width: 900px;
			margin: 0 auto;
			padding: 20px;
		}

		.hero-section {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 40px 30px;
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
		}

		.hero-section h1 {
			margin: 0 0 15px 0;
			font-size: 2.2em;
			font-weight: 600;
		}

		.hero-section p {
			margin: 0;
			font-size: 1.1em;
			opacity: 0.95;
		}

		.quick-start {
			background: #fff;
			border: 2px solid #667eea;
			border-radius: 12px;
			padding: 30px;
			margin-bottom: 30px;
			text-align: center;
		}

		.quick-start h2 {
			color: #667eea;
			margin-top: 0;
		}

		.quick-start p {
			color: #666;
			margin-bottom: 20px;
		}

		.action-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin: 20px 0;
		}

		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			padding: 16px 32px;
			border-radius: 8px;
			font-size: 1.1em;
			font-weight: 600;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
			box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
		}

		.btn-secondary {
			background: white;
			color: #667eea;
			border: 2px solid #667eea;
			padding: 14px 30px;
			border-radius: 8px;
			font-size: 1.05em;
			font-weight: 500;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
		}

		.btn-secondary:hover {
			background: #f0f4ff;
			transform: translateY(-2px);
		}

		.btn-success {
			background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
			color: white;
			border: none;
			padding: 14px 28px;
			border-radius: 8px;
			font-size: 1.05em;
			font-weight: 600;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(86, 171, 47, 0.4);
		}

		.btn-success:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 18px rgba(86, 171, 47, 0.5);
		}

		.divider {
			text-align: center;
			margin: 30px 0;
			position: relative;
		}

		.divider::before {
			content: '';
			position: absolute;
			left: 0;
			top: 50%;
			width: 100%;
			height: 1px;
			background: #e0e0e0;
		}

		.divider span {
			background: white;
			padding: 0 20px;
			position: relative;
			color: #999;
			font-weight: 500;
		}

		.upload-section {
			background: white;
			border: 2px dashed #d1d5db;
			border-radius: 12px;
			padding: 40px;
			text-align: center;
			transition: all 0.3s ease;
			cursor: pointer;
		}

		.upload-section:hover {
			border-color: #667eea;
			background: #f9fafb;
		}

		.file-input-wrapper {
			position: relative;
			display: inline-block;
			margin: 20px 0;
		}

		.file-input-label {
			display: inline-block;
			padding: 14px 32px;
			background: #667eea;
			color: white;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 500;
			font-size: 1.05em;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
		}

		.file-input-label:hover {
			background: #5568d3;
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
		}

		input[type="file"] {
			position: absolute;
			opacity: 0;
			width: 0;
			height: 0;
		}

		.file-name-display {
			margin-top: 15px;
			color: #666;
			font-size: 0.95em;
			min-height: 20px;
		}

		.info-note {
			background: #f0f4ff;
			border-left: 4px solid #667eea;
			padding: 15px 20px;
			border-radius: 6px;
			margin: 20px 0;
			color: #555;
		}

		.results-section {
			background: #fafafa;
			padding: 30px;
			margin: 40px auto 30px auto;
			box-shadow: 0 4px 20px rgba(86, 171, 47, 0.15);
			border: 2px solid #56ab2f;
			border-radius: 12px;
			/* Wider than normal sections but scales with zoom */
			width: calc(min(1800px, max(80% - 40px, 900px)));
		}

		.results-section h2 {
			color: #56ab2f;
			margin-top: 0;
			font-size: 1.8em;
			text-align: center;
			margin-bottom: 25px;
		}

		.results-content-wrapper {
			margin: 0 auto;
		}

		.plot-container {
			background: white;
			padding: 15px;
			margin: 20px;
			text-align: center;
		}

		.plot-container img {
			width: 100%;
			max-width: 100%;
			height: auto;
			display: block;
			margin: 0 auto;
		}

		.error-section {
			background: white;
			border: 2px solid #e74c3c;
			border-radius: 12px;
			padding: 30px;
			margin-top: 40px;
			margin-bottom: 30px;
			box-shadow: 0 4px 20px rgba(231, 76, 60, 0.15);
		}

		.error-section h2 {
			color: #e74c3c;
			margin-top: 0;
			font-size: 1.8em;
			text-align: center;
			margin-bottom: 20px;
		}

		.error-message {
			background: #fee;
			border: 1px solid #fcc;
			padding: 15px;
			border-radius: 6px;
			margin: 15px 0;
			color: #c33;
		}

		.error-message strong {
			display: block;
			margin-bottom: 8px;
			font-size: 1.05em;
		}

		.help-text {
			background: #f0f4ff;
			border-left: 4px solid #667eea;
			padding: 15px 20px;
			border-radius: 6px;
			margin: 20px 0;
			color: #555;
		}

		.tech-details {
			margin-top: 20px;
		}

		.tech-details summary {
			cursor: pointer;
			color: #667eea;
			font-weight: 500;
			padding: 10px;
			background: #f8f9fa;
			border-radius: 6px;
			user-select: none;
		}

		.tech-details summary:hover {
			background: #e9ecef;
		}

		.tech-details pre {
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			padding: 15px;
			overflow: auto;
			font-size: 12px;
			border-radius: 6px;
			margin-top: 10px;
			line-height: 1.5;
		}

		.user-manual {
			background: white;
			border: 2px solid #e0e0e0;
			border-radius: 12px;
			padding: 35px;
			margin: 30px 0;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}

		.user-manual h2 {
			color: #667eea;
			margin-top: 0;
			font-size: 1.9em;
			margin-bottom: 20px;
			border-bottom: 3px solid #667eea;
			padding-bottom: 10px;
		}

		.user-manual p {
			color: #444;
			line-height: 1.75;
			margin: 16px 0;
			font-size: 1.02em;
		}

		.user-manual p:first-of-type {
			font-size: 1.08em;
			color: #333;
			font-weight: 500;
		}

		.user-manual strong {
			color: #667eea;
			font-weight: 600;
		}

		.user-manual code {
			background: #f0f4ff;
			padding: 2px 6px;
			border-radius: 3px;
			font-family: 'Courier New', monospace;
			font-size: 0.92em;
			color: #5568d3;
			border: 1px solid #d1d9f5;
		}

		.user-manual h3 {
			color: #667eea;
			font-size: 1.3em;
			margin-top: 28px;
			margin-bottom: 12px;
			font-weight: 600;
		}
	</style>
</head>
{% endblock %}

{% block content %}
<div class="tool-container">
	<div class="hero-section">
		<h1>üß¨ Isoforms Plot Generator</h1>
		<p>Visualize transcript isoforms with splice sites and fragment structures</p>
	</div>

	{# Results section - shown right after hero when results are available #}
	{% if error_message %}
	<div class="error-section">
		<h2>‚ö†Ô∏è Error</h2>
		<div class="error-message">
			{{ error_message }}
		</div>
		{% if error_details %}
		<div class="help-text">
			<strong>üí° Common Issues</strong>
			<ul style="margin: 10px 0 0 0; padding-left: 20px;">
				<li>Invalid colour names (allowed: red, blue, green, orange, purple, cyan, magenta, yellow, pink, brown, lime, navy)</li>
				<li>Missing or malformed CSV sections</li>
				<li>Incorrect column formatting</li>
			</ul>
		</div>
		<details class="tech-details">
			<summary>üîç Show Technical Details</summary>
			<pre>{{ error_details }}</pre>
		</details>
		{% endif %}
	</div>
	{% endif %}
</div>

{# Results section - outside tool-container to allow wider width #}
{% if svg_path %}
<div class="results-section">
	<div class="results-content-wrapper">
		<h2>‚úÖ Plot Generated</h2>
	</div>
	<div class="plot-container">
		<img src="{{ svg_path }}" alt="Isoforms Plot" />
	</div>
	<div class="results-content-wrapper">
		<div class="action-buttons">
			<a href="{{ svg_path }}" download="isoforms.svg" class="btn-success">
				üíæ Download SVG
			</a>
		</div>
	</div>
</div>
{% endif %}

<div class="tool-container">
	<div class="quick-start">
		<h2>‚ö° Quick Start</h2>
		<p>Try the example data first</p>
		<a href="{% url 'use_example' %}" class="btn-primary">üé® Generate Example Plot</a>
		<div style="margin-top:15px;">
			<a href="{% url 'download_default' %}" class="btn-secondary">‚¨áÔ∏è Download Example CSV</a>
		</div>
	</div>

	<div class="divider"><span>OR UPLOAD YOUR DATA</span></div>

	<form enctype="multipart/form-data" id="mainForm" name="mainForm" method="post" action="{% url 'results' %}">
		{% csrf_token %}

		<div class="upload-section">
			<div class="file-input-wrapper">
				<label for="file" class="file-input-label">üìÅ Choose File</label>
				<input type="file" name="file" id="file" accept=".csv" required>
			</div>

			<h4 style="margin-top:0; color:#333;">Can drag & drop a file here</h4>
			<div class="file-name-display" id="fileNameDisplay"></div>
		</div>
	</form>

	<div class="user-manual">
		<h2>üìñ How CSV Input Works</h2>

		<p>
			The CSV is a <strong>structured description of splicing</strong>: splice sites are declared first, then each transcript is described as a <em>path that connects those sites</em>. All fragment boundaries must correspond to declared splice sites.
		</p>

		<p>
			The file is organized into <strong>named sections</strong>. Each section begins with a bracketed header like <code>[transcripts]</code>, followed by a CSV table with a header row. Three sections are required: <code>[transcripts]</code>, <code>[donors]</code>, and <code>[acceptors]</code>. The optional <code>[title]</code> section provides a title that appears at the top of the plot.
		</p>

		<h3>Splice Sites</h3>
		<p>
			In <code>[donors]</code> and <code>[acceptors]</code>, each row defines one splice site with three fields: <code>name</code> (the label shown below the genome map), <code>position</code> (integer coordinate, marked by a small vertical tick), and <code>colour</code> (optional). When a colour is specified, all fragments touching that splice site inherit that colour. Allowed colours: <em><a style="color: red">red</a>, <a style="color: blue">blue</a>, <a style="color: green">green</a>, <a style="color: orange">orange</a>, <a style="color: purple">purple</a>, <a style="color: cyan">cyan</a>, <a style="color: magenta">magenta</a>, <a style="color: yellow">yellow</a>, <a style="color: pink">pink</a>, <a style="color: brown">brown</a>, <a style="color: lime">lime</a>, <a style="color: navy">navy</a></em>.
		</p>

		<p>
			Splice site names must be unique within each category (all donor names must be distinct, and all acceptor names must be distinct). Positions can be any positive integer. If two splice sites at different positions need to be visually grouped, assign them the same colour.
		</p>

		<h3>Transcripts</h3>
		<p>
			In <code>[transcripts]</code>, each row describes one transcript. The required <code>fragments</code> field lists exon-like blocks in <code>start-end</code> format, separated by semicolons (e.g., <code>1-200; 500-800; 1000-end</code>). Fragments can start at position 1 or any declared acceptor, and must end at a declared donor or the keyword <code>end</code>. The keyword <code>end</code> is case-insensitive and represents the final position on the reference sequence. Fragment boundaries <em>must</em> match declared splice sites‚Äîarbitrary coordinates will be rejected.
		</p>

		<p>
			Three optional fields control how transcripts appear: <code>label</code>, <code>group</code>, and <code>N_observed</code>. The <code>label</code> appears at the right side above the transcript (typically a gene or isoform name). The <code>group</code> field clusters related transcripts visually‚Äîtranscripts sharing the same group name are drawn as a block, marked by a vertical line on the left edge of the plot. The <code>N_observed</code> appears on the right side of the transcript (commonly used for read counts or sample metadata).
		</p>

		<p>
			Fragments within a single transcript must not overlap. If fragment <em>A</em> ends at position 500 and fragment <em>B</em> starts at position 500, they will be rejected as overlapping. Fragment <em>B</em> must start at a position <em>after</em> fragment <em>A</em>'s end position. Fragments are displayed in the order they appear in the CSV.
		</p>

		<h3>Colours and Conflicts</h3>
		<p>
			When a fragment touches two splice sites with different colours (one at the start, one at the end), the tool will reject the input with a conflict error. Each fragment can have only one colour. To resolve this, either remove one of the colours from the splice sites, or adjust the fragment boundaries so they don't span conflicting colours.
		</p>

		<h3>Label Deduplication</h3>
		<p>
			When multiple consecutive transcripts have the same label, the tool automatically removes duplicate labels to avoid clutter. For example, if three transcripts in a row all have label <code>gag</code>, only the first one will display the label. This behaviour applies only to consecutive transcripts‚Äîif a different label appears in between, the repeated label will be shown again.
		</p>

		<h3>Groups and Visual Organization</h3>
		<p>
			The group field organizes transcripts into visual blocks. All transcripts with the same group value are drawn together, separated from other groups by spacing. A vertical bar on the left marks each group. Groups appear in the order they first occur in the CSV (preserve the order of first appearance). If a transcript has no group specified (empty or omitted), it's treated as belonging to its own unnamed group.
		</p>

		<h3>Common Mistakes</h3>
		<p>
			If a needed position is missing from the donors/acceptors sections, add it there rather than attempting to use an undeclared position. Fragment ranges must use integers for both start and end (except for the <code>end</code> keyword). Negative numbers and zero are not allowed. Whitespace around fragment ranges is ignored, so <code>1-200</code>, <code>1 - 200</code>, and <code> 1-200 </code> are all equivalent.
		</p>

		<h3>Technical Details</h3>
		<p>
			The <code>end</code> keyword is internally mapped to position 9632, which is displayed as the rightmost point on the genome map. Section headers are case-insensitive (<code>[transcripts]</code>, <code>[TRANSCRIPTS]</code>, and <code>[Transcripts]</code> are all equivalent), but duplicate section headers (even with different casing) will be rejected. CSV parsing follows standard rules: fields can be quoted to include commas or newlines.
		</p>
	</div>
</div>

<script>
	const fileInput = document.getElementById('file');
	const fileDisplay = document.getElementById('fileNameDisplay');
	const form = document.getElementById('mainForm');
	const uploadSection = document.querySelector('.upload-section');

	// Handle file selection via button
	fileInput.addEventListener('change', function (e) {
		if (e.target.files.length > 0) {
			fileDisplay.textContent = 'üìÑ ' + e.target.files[0].name;
			fileDisplay.style.color = '#667eea';
			fileDisplay.style.fontWeight = '500';

			// Auto-submit the form when file is selected
			form.submit();
		} else {
			fileDisplay.textContent = '';
		}
	});

	// Prevent default drag behaviors
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		uploadSection.addEventListener(eventName, preventDefaults, false);
		document.body.addEventListener(eventName, preventDefaults, false);
	});

	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}

	// Highlight drop area when item is dragged over it
	['dragenter', 'dragover'].forEach(eventName => {
		uploadSection.addEventListener(eventName, highlight, false);
	});

	['dragleave', 'drop'].forEach(eventName => {
		uploadSection.addEventListener(eventName, unhighlight, false);
	});

	function highlight(e) {
		uploadSection.style.borderColor = '#667eea';
		uploadSection.style.backgroundColor = '#f9fafb';
	}

	function unhighlight(e) {
		uploadSection.style.borderColor = '#d1d5db';
		uploadSection.style.backgroundColor = 'white';
	}

	// Handle dropped files
	uploadSection.addEventListener('drop', handleDrop, false);

	function handleDrop(e) {
		const dt = e.dataTransfer;
		const files = dt.files;

		if (files.length > 0) {
			// Assign dropped file to the file input
			fileInput.files = files;

			// Display file name
			fileDisplay.textContent = 'üìÑ ' + files[0].name;
			fileDisplay.style.color = '#667eea';
			fileDisplay.style.fontWeight = '500';

			// Auto-submit the form
			form.submit();
		}
	}
</script>
{% endblock %}
