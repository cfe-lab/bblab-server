{% extends "tool_base.html" %}
{% load static %}

{% block head %}

<head>
	<link rel="stylesheet" href="{% static " usc_style.css" %}" />
	<title>Isoforms Plot Generator</title>
	<style>
		.tool-container {
			max-width: 900px;
			margin: 0 auto;
			padding: 20px;
		}

		.hero-section {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 40px 30px;
			border-radius: 12px;
			margin-bottom: 30px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
		}

		.hero-section h1 {
			margin: 0 0 15px 0;
			font-size: 2.2em;
			font-weight: 600;
		}

		.hero-section p {
			margin: 0;
			font-size: 1.1em;
			opacity: 0.95;
		}

		.quick-start {
			background: #fff;
			border: 2px solid #667eea;
			border-radius: 12px;
			padding: 30px;
			margin-bottom: 30px;
			text-align: center;
		}

		.quick-start h2 {
			color: #667eea;
			margin-top: 0;
		}

		.quick-start p {
			color: #666;
			margin-bottom: 20px;
		}

		.action-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin: 20px 0;
		}

		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			padding: 16px 32px;
			border-radius: 8px;
			font-size: 1.1em;
			font-weight: 600;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
			box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
		}

		.btn-secondary {
			background: white;
			color: #667eea;
			border: 2px solid #667eea;
			padding: 14px 30px;
			border-radius: 8px;
			font-size: 1.05em;
			font-weight: 500;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
		}

		.btn-secondary:hover {
			background: #f0f4ff;
			transform: translateY(-2px);
		}

		.btn-success {
			background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
			color: white;
			border: none;
			padding: 14px 28px;
			border-radius: 8px;
			font-size: 1.05em;
			font-weight: 600;
			cursor: pointer;
			text-decoration: none;
			display: inline-block;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(86, 171, 47, 0.4);
		}

		.btn-success:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 18px rgba(86, 171, 47, 0.5);
		}

		.divider {
			text-align: center;
			margin: 30px 0;
			position: relative;
		}

		.divider::before {
			content: '';
			position: absolute;
			left: 0;
			top: 50%;
			width: 100%;
			height: 1px;
			background: #e0e0e0;
		}

		.divider span {
			background: white;
			padding: 0 20px;
			position: relative;
			color: #999;
			font-weight: 500;
		}

		.upload-section {
			background: white;
			border: 2px dashed #d1d5db;
			border-radius: 12px;
			padding: 40px;
			text-align: center;
			transition: all 0.3s ease;
		}

		.upload-section:hover {
			border-color: #667eea;
			background: #f9fafb;
		}

		.file-input-wrapper {
			position: relative;
			display: inline-block;
			margin: 20px 0;
		}

		.file-input-label {
			display: inline-block;
			padding: 14px 32px;
			background: #667eea;
			color: white;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 500;
			font-size: 1.05em;
			transition: all 0.3s ease;
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
		}

		.file-input-label:hover {
			background: #5568d3;
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
		}

		input[type="file"] {
			position: absolute;
			opacity: 0;
			width: 0;
			height: 0;
		}

		.file-name-display {
			margin-top: 15px;
			color: #666;
			font-size: 0.95em;
			min-height: 20px;
		}

		.info-note {
			background: #f0f4ff;
			border-left: 4px solid #667eea;
			padding: 15px 20px;
			border-radius: 6px;
			margin: 20px 0;
			color: #555;
		}

		.results-section {
			background: white;
			padding: 30px;
			margin: 40px auto 30px auto;
			box-shadow: 0 4px 20px rgba(86, 171, 47, 0.15);
			border: 2px solid #56ab2f;
			border-radius: 12px;
			/* Wider than normal sections but with gaps */
			width: 90%;
			max-width: none;
		}

		.results-section h2 {
			color: #56ab2f;
			margin-top: 0;
			font-size: 1.8em;
			text-align: center;
			margin-bottom: 25px;
		}

		.results-content-wrapper {
			max-width: 900px;
			margin: 0 auto;
		}

		.plot-container {
			background: #fafafa;
			padding: 15px;
			margin: 20px;
			text-align: center;
		}

		.plot-container img {
			width: 100%;
			max-width: 100%;
			height: auto;
			display: block;
			margin: 0 auto;
		}

		.error-section {
			background: white;
			border: 2px solid #e74c3c;
			border-radius: 12px;
			padding: 30px;
			margin-top: 40px;
			margin-bottom: 30px;
			box-shadow: 0 4px 20px rgba(231, 76, 60, 0.15);
		}

		.error-section h2 {
			color: #e74c3c;
			margin-top: 0;
			font-size: 1.8em;
			text-align: center;
			margin-bottom: 20px;
		}

		.error-message {
			background: #fee;
			border: 1px solid #fcc;
			padding: 15px;
			border-radius: 6px;
			margin: 15px 0;
			color: #c33;
		}

		.error-message strong {
			display: block;
			margin-bottom: 8px;
			font-size: 1.05em;
		}

		.help-text {
			background: #f0f4ff;
			border-left: 4px solid #667eea;
			padding: 15px 20px;
			border-radius: 6px;
			margin: 20px 0;
			color: #555;
		}

		.tech-details {
			margin-top: 20px;
		}

		.tech-details summary {
			cursor: pointer;
			color: #667eea;
			font-weight: 500;
			padding: 10px;
			background: #f8f9fa;
			border-radius: 6px;
			user-select: none;
		}

		.tech-details summary:hover {
			background: #e9ecef;
		}

		.tech-details pre {
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			padding: 15px;
			overflow: auto;
			font-size: 12px;
			border-radius: 6px;
			margin-top: 10px;
			line-height: 1.5;
		}

		.user-manual {
			background: white;
			border: 2px solid #e0e0e0;
			border-radius: 12px;
			padding: 35px;
			margin: 30px 0;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}

		.user-manual h2 {
			color: #667eea;
			margin-top: 0;
			font-size: 1.9em;
			margin-bottom: 20px;
			border-bottom: 3px solid #667eea;
			padding-bottom: 10px;
		}

		.user-manual p {
			color: #444;
			line-height: 1.75;
			margin: 16px 0;
			font-size: 1.02em;
		}

		.user-manual p:first-of-type {
			font-size: 1.08em;
			color: #333;
			font-weight: 500;
		}

		.user-manual strong {
			color: #667eea;
			font-weight: 600;
		}

		.user-manual code {
			background: #f0f4ff;
			padding: 2px 6px;
			border-radius: 3px;
			font-family: 'Courier New', monospace;
			font-size: 0.92em;
			color: #5568d3;
			border: 1px solid #d1d9f5;
		}
	</style>
</head>
{% endblock %}

{% block content %}
<div class="tool-container">
	<div class="hero-section">
		<h1>üß¨ Isoforms Plot Generator</h1>
		<p>Visualize transcript isoforms with splice sites and fragment structures</p>
	</div>

	{# Results section - shown right after hero when results are available #}
	{% if error_message %}
	<div class="error-section">
		<h2>‚ö†Ô∏è Error</h2>
		<div class="error-message">
			{{ error_message }}
		</div>
		{% if error_details %}
		<div class="help-text">
			<strong>üí° Common Issues</strong>
			<ul style="margin: 10px 0 0 0; padding-left: 20px;">
				<li>Invalid colour names (allowed: red, blue, green, orange, purple, cyan, magenta, yellow, pink, brown, lime, navy)</li>
				<li>Missing or malformed CSV sections</li>
				<li>Incorrect column formatting</li>
			</ul>
		</div>
		<details class="tech-details">
			<summary>üîç Show Technical Details</summary>
			<pre>{{ error_details }}</pre>
		</details>
		{% endif %}
	</div>
	{% endif %}
</div>

{# Results section - outside tool-container to allow wider width #}
{% if svg_path %}
<div class="results-section">
	<div class="results-content-wrapper">
		<h2>‚úÖ Plot Generated</h2>
	</div>
	<div class="plot-container">
		<img src="{{ svg_path }}" alt="Isoforms Plot" />
	</div>
	<div class="results-content-wrapper">
		<div class="action-buttons">
			<a href="{{ svg_path }}" download="isoforms.svg" class="btn-success">
				üíæ Download SVG
			</a>
		</div>
	</div>
</div>
{% endif %}

<div class="tool-container">
	<div class="quick-start">
		<h2>‚ö° Quick Start</h2>
		<p>Try the example data first</p>
		<a href="{% url 'use_example' %}" class="btn-primary">üé® Generate Example Plot</a>
		<div style="margin-top:15px;">
			<a href="{% url 'download_default' %}" class="btn-secondary">‚¨áÔ∏è Download Example CSV</a>
		</div>
	</div>

	<div class="divider"><span>OR UPLOAD YOUR DATA</span></div>

	<form enctype="multipart/form-data" id="mainForm" name="mainForm" method="post" action="{% url 'results' %}">
		{% csrf_token %}

		<div class="upload-section">
			<div class="file-input-wrapper">
				<label for="file" class="file-input-label">üìÅ Choose File</label>
				<input type="file" name="file" id="file" accept=".csv" required>
			</div>

			<h4 style="margin-top:0; color:#333;">Can drag & drop a file here</h4>
			<div class="file-name-display" id="fileNameDisplay"></div>
		</div>
	</form>

	<div class="user-manual">
		<h2>üìñ How CSV Input Works</h2>
		
		<p>
			Your CSV is best thought of as a <strong>small, structured description of splicing</strong>: first you declare the splice sites you care about, then you describe each transcript as a <strong>path that jumps between those sites</strong>. This design is intentional: it keeps the plot consistent across many isoforms, prevents "almost-the-same coordinate" typos from silently creating misleading pictures, and makes it easy to compare transcripts because all boundaries line up on the same declared landmarks.
		</p>

		<p>
			The file is organized into <strong>named sections</strong>. Each section begins with a bracketed header like <code>[transcripts]</code>, and then contains a normal CSV table with a header row. Three sections are required: <strong><code>[transcripts]</code></strong>, <strong><code>[donors]</code></strong>, and <strong><code>[acceptors]</code></strong>. A <strong><code>[title]</code></strong> section is optional and exists purely to give the figure a human-readable title (useful when you're saving or sharing plots).
		</p>

		<p>
			In <strong><code>[donors]</code></strong> and <strong><code>[acceptors]</code></strong>, you define the splice sites that transcripts are allowed to connect to. Each site has a <strong>name</strong> (a short identifier you'll recognize on the plot), a <strong>position</strong> (an integer coordinate along the reference), and an optional <strong>colour</strong>. Colours are a way to visually tag related splice sites (for example, to emphasize alternative splicing patterns or highlight families of sites) so that the diagram communicates structure at a glance instead of forcing the viewer to read every coordinate.
		</p>

		<p>
			In <strong><code>[transcripts]</code></strong>, each row describes one transcript as a series of <strong>fragments</strong>. Conceptually, a fragment is an exon-like block: it begins at a splice acceptor (or the very start of the reference) and ends at a splice donor (or the end of the reference). The key idea is that <strong>fragment boundaries are not arbitrary</strong>‚Äîthey must match the splice sites you declared. This turns your input from "a pile of coordinates" into a coherent splicing map where every transcript is assembled from the same set of well-defined cut points, which is exactly what makes isoforms comparable in a single figure.
		</p>

		<p>
			Transcripts can optionally include a <strong>label</strong>, a <strong>group</strong>, and a <strong>comment</strong>. Labels help identify a transcript (e.g., a gene name or isoform name) without cluttering the drawing. Groups let you cluster related transcripts into blocks so the figure reads as "families" rather than a flat list; the goal is to help viewers understand patterns (e.g., "these are all variants of the same class") before they inspect details. Comments are free-form notes that appear alongside the transcript, useful for short metadata like sample IDs, counts, or brief annotations.
		</p>

		<p>
			A final practical principle: if you find yourself wanting a transcript fragment to start or end at a position that isn't currently allowed, that's a sign you should <strong>add the corresponding splice site</strong> to the donors/acceptors list instead of forcing a one-off boundary. Doing so keeps the whole dataset internally consistent and makes the plot easier to read and trust‚Äîboth for you and for anyone you share it with.
		</p>
	</div>
</div>

<script>
	document.getElementById('file').addEventListener('change', function (e) {
		const fileDisplay = document.getElementById('fileNameDisplay');
		const form = document.getElementById('mainForm');

		if (e.target.files.length > 0) {
			fileDisplay.textContent = 'üìÑ ' + e.target.files[0].name;
			fileDisplay.style.color = '#667eea';
			fileDisplay.style.fontWeight = '500';

			// Auto-submit the form when file is selected
			form.submit();
		} else {
			fileDisplay.textContent = '';
		}
	});
</script>
{% endblock %}